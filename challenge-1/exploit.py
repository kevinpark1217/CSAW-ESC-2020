import os

# riscv environment setup
riscv_path = os.path.abspath("../riscv/bin")
os.environ["PATH"] = f'{riscv_path}:{os.environ["PATH"]}'

from pwn import *

# context.terminal = ['tmux', 'splitw', '-h']
# context.arch = "riscv32"
binary = '../docker/qual-esc2020.elf'

bin = ELF(binary)

conn = remote('127.0.0.1', 4444)
gdb.attach(target=('127.0.0.1', 1234), gdbscript='''
break *0x204002f2
''', exe=binary)

# Pick 1st challenge
print(conn.recvline().decode("utf-8"))
conn.sendline(b"1")

# Calculate solution based on memory analysis
payload = "CSE"
inter = b""
more = [0x2d435345, 0x30323032]
for m in more:
    inter += p32(m)
inter = [chr(inter[i] - i) for i in range(len(inter))]
payload += "".join(inter)
print(f"Solution: {payload}")

# Enter 16 characters
print(conn.recvline().decode("utf-8"))
conn.sendline(payload)

# Solved message
print(conn.recvline().decode("utf-8"))

# conn.interactive()
conn.close()